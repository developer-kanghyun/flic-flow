import{u as B,j as s,S as V,T as z,a as J,r as u,b as Y,g as Q,c as X,R as Z,W as ee,d as k,L,e as te,f as se,h as re,i as ae,F as oe,M as ne,C as ie,k as O,l as ce,H as le,m as de,n as ue,o as ge,p as pe,q as E,s as he,t as ye,P as me,v as j,w as D,A as h,x as _e,y as _,G as g,z as ve}from"./index-le49yNCJ.js";import{S as fe,a as xe,b as je}from"./styles-CT8vt3Ob.js";import{f as Se,a as Te}from"./omdbApi-BBekdXAk.js";const Me=()=>{const{activeTag:e,setActiveTag:a}=B();return s.jsx(V,{children:z.map(t=>s.jsx(J,{$active:e===t.key,onClick:()=>a(t.key),children:t.label},t.key))})},we=()=>{const{selectedOtts:e}=B(),[a,t]=u.useState([]),[r,o]=u.useState(!0),[n,l]=u.useState(null);if(u.useEffect(()=>{(async()=>{try{const c=await Q();t(c||[])}catch(c){console.error("Error fetching all watch providers:",c),l("OTT 제공사 정보를 불러오는 데 실패했습니다.")}finally{o(!1)}})()},[]),r)return null;if(n)return s.jsx("p",{style:{color:"red"},children:n});const d=a.filter(i=>e.includes(i.provider_id));return s.jsxs(Y,{children:[s.jsx("div",{className:"label",children:"선택된 서비스 :"}),s.jsx("div",{className:"otts-list",children:d.length===0?s.jsx("span",{className:"no-selection",children:"선택된 서비스가 없습니다"}):d.map(i=>s.jsx("img",{className:"ott-item",src:`https://image.tmdb.org/t/p/original${i.logo_path}`,alt:i.provider_name,title:i.provider_name},i.provider_id))})]})},Ie=({movie:e,rank:a})=>{const t=e.name&&!e.title?"tv":"movie",r=`/detail/${e.id}?type=${t}`,o=e.title||e.name||"제목 없음";return s.jsxs(X,{children:[s.jsx(Z,{children:a}),s.jsx(ee,{children:s.jsx(k,{movieId:e.id})}),s.jsx(L,{to:r,children:e.poster_path?s.jsx("img",{src:`https://image.tmdb.org/t/p/w500${e.poster_path}`,alt:o}):s.jsx("div",{className:"no-image",children:"No Image"})})]})},Ne=({movies:e,title:a})=>{const t=e.slice(0,5);return s.jsxs(te,{children:[s.jsx("h2",{children:a}),s.jsx(se,{children:t.map((r,o)=>s.jsx(Ie,{movie:r,rank:o+1},r.id))})]})},m=({movies:e,title:a})=>{if(e.length===0)return null;const t=e.slice(0,5),r=e.slice(5,26);return s.jsxs(re,{children:[s.jsx(ae,{children:s.jsx("h3",{children:a})}),s.jsx(oe,{children:t.map(o=>s.jsx("div",{className:"grid-item",children:s.jsx(ne,{movie:o})},o.id))}),r.length>0&&s.jsx(ie,{children:s.jsx(O,{movies:r,title:`${a} 더보기`})})]})},Re=({movie:e})=>{var n;const[a,t]=u.useState(!1),[r,o]=u.useState({imdbRating:null,rottenTomatoesRating:null});return u.useEffect(()=>{const l=new Image;l.onload=()=>t(!0),l.src=`https://image.tmdb.org/t/p/original${e.backdrop_path}`},[e.backdrop_path]),u.useEffect(()=>{(async()=>{try{const d=await Se(e.id);if(d){const i=await Te(d);i&&o({imdbRating:i.imdbRating,rottenTomatoesRating:i.rottenTomatoesRating})}}catch(d){console.error("Error fetching ratings:",d)}})()},[e.id]),s.jsxs(ce,{children:[s.jsx(le,{style:{backgroundImage:a?`url(https://image.tmdb.org/t/p/original${e.backdrop_path})`:"none"}}),s.jsx(de,{children:s.jsxs(ue,{children:[s.jsx(ge,{children:e.title||e.name}),s.jsxs(pe,{children:[s.jsxs(E,{children:[s.jsx("span",{className:"imdb-label",children:"IMDB"}),s.jsx("span",{className:"rating-score",children:r.imdbRating||((n=e.vote_average)==null?void 0:n.toFixed(1))||"8.2"})]}),s.jsxs(E,{className:"rotten-tomatoes",children:[s.jsx("span",{className:"rt-label",children:"🍅"}),s.jsx("span",{className:"rt-score",children:r.rottenTomatoesRating||`${Math.round((e.vote_average||8.2)*8.5)}%`})]}),s.jsx("span",{className:"release-year",children:e.release_date?new Date(e.release_date).getFullYear():"2024"})]}),s.jsx(he,{children:e.overview?e.overview.length>180?`${e.overview.substring(0,180)}...`:e.overview:"줄거리 정보가 없습니다."}),s.jsxs(ye,{children:[s.jsx(L,{to:`/detail/${e.id}`,children:s.jsx(me,{children:"상세보기"})}),s.jsx(k,{movieId:e.id})]})]})})]})},I=async(e,a=20)=>{try{const t=await j.get("/trending/all/day"),r=new Date().toISOString().split("T")[0],o=t.data.results.filter(n=>{var c;const l=(c=n.genre_ids)==null?void 0:c.some(y=>e.includes(y)),d=n.release_date||n.first_air_date,i=!d||d<=r;return l&&i}).map(n=>({...n,media_type:n.media_type||(n.title?"movie":"tv")})).slice(0,Math.min(a,10));if(o.length<a){const n=a-o.length,[l,d]=await Promise.all([j.get("/discover/movie",{params:{with_genres:e.join(","),sort_by:"popularity.desc","primary_release_date.lte":r,"primary_release_date.gte":"2020-01-01","vote_count.gte":10}}),j.get("/discover/tv",{params:{with_genres:e.join(","),sort_by:"popularity.desc","first_air_date.lte":r,"first_air_date.gte":"2020-01-01","vote_count.gte":10}})]),i=[...l.data.results.map(c=>({...c,media_type:"movie"})),...d.data.results.map(c=>({...c,media_type:"tv"}))].filter(c=>!o.some(y=>y.id===c.id)).sort((c,y)=>(y.popularity||0)-(c.popularity||0)).slice(0,n);o.push(...i)}return o.slice(0,a)}catch(t){throw console.error("Error fetching genre-based trending:",t),t}},Be=e=>{const a=e.title||e.name||"",t=Math.max(100-a.length*2,10),r=(e.vote_average||5)*10,o=Math.log((e.vote_count||1)+1)*5;return t+r+o},be=e=>{const a=e.release_date||e.first_air_date;if(!a)return 0;const t=new Date,r=new Date(a),o=Math.abs((t.getTime()-r.getTime())/(1e3*60*60*24));return o<=30?100:o<=90?80:o<=365?60:o<=365*2?40:20},Ce=e=>{const a=e.popularity||0,t=e.vote_average||0,r=e.vote_count||0;return a*.4+t*10*.3+Math.log(r+1)*5*.3},Ae=e=>{const a=(e.title||e.name||"").toLowerCase(),t=["시즌","season","완결","신작","화제","마블","marvel","디즈니","disney","넷플릭스","netflix","스파이더맨","어벤져스","원피스","나루토","귀멸의칼날","오징어게임","킹덤","지옥","라라랜드","탑건"];let r=0;return t.forEach(o=>{a.includes(o)&&(r+=20)}),Math.min(r,100)},Ee=e=>e.map(t=>{const r=t.popularity||0,o=be(t),n=Ce(t),l=Ae(t),d=Be(t),i=r*.25+o*.2+n*.25+l*.15+d*.15;return{...t,_truePopularityScore:i}}).sort((t,r)=>(r._truePopularityScore||0)-(t._truePopularityScore||0)),F=async(e,a=20,t)=>{try{const r=new Date().toISOString().split("T")[0];let o=[];(!t||t.length===0)&&(o=(await j.get("/trending/all/day")).data.results.filter(v=>{var w;const S=(w=v.genre_ids)==null?void 0:w.some(f=>e.includes(f)),T=v.release_date||v.first_air_date,M=!T||T<=r;return S&&M}).slice(0,10));const n={with_genres:e.join(","),sort_by:"popularity.desc","primary_release_date.lte":r,"primary_release_date.gte":"2022-01-01","vote_count.gte":20},l={with_genres:e.join(","),sort_by:"popularity.desc","first_air_date.lte":r,"first_air_date.gte":"2022-01-01","vote_count.gte":15};t&&t.length>0&&(n.with_watch_providers=t.join("|"),n.watch_region="KR",l.with_watch_providers=t.join("|"),l.watch_region="KR");const[d,i]=await Promise.all([j.get("/discover/movie",{params:n}),j.get("/discover/tv",{params:l})]),c=[...o.map(p=>({...p,media_type:p.media_type||(p.title?"movie":"tv")})),...d.data.results.map(p=>({...p,media_type:"movie"})),...i.data.results.map(p=>({...p,media_type:"tv"}))],y=Array.from(new Map(c.map(p=>[p.id,p])).values());return Ee(y).slice(0,a)}catch(r){throw console.error("Error fetching true popular content:",r),r}},G=e=>ve[e]||"콘텐츠",Ge=async(e,a)=>{const t={sortBy:"popularity.desc",count:h.SINGLE_TAG_COUNT};switch(a){case"new":{t.sortBy="popularity.desc";const r=new Date;r.setMonth(r.getMonth()-h.RECENT_MONTHS);const o=r.toISOString().split("T")[0];return _e(o,h.SINGLE_TAG_COUNT,e.ottIds)}case"trending_day":if(!e.ottIds||e.ottIds.length===0)return D(h.SINGLE_TAG_COUNT,"day");t.sortBy="popularity.desc";break;case"action":if(!e.ottIds||e.ottIds.length===0)return I(g.action,h.SINGLE_TAG_COUNT);t.genreIds=g.action,t.mediaType="movie",t.sortBy="popularity.desc";break;case"comedy":if(!e.ottIds||e.ottIds.length===0)return I(g.comedy,h.SINGLE_TAG_COUNT);t.genreIds=g.comedy,t.sortBy="popularity.desc";break;case"drama":if(!e.ottIds||e.ottIds.length===0)return I(g.drama,h.SINGLE_TAG_COUNT);t.genreIds=g.drama,t.sortBy="popularity.desc";break;case"horror":if(!e.ottIds||e.ottIds.length===0)return I(g.horror,h.SINGLE_TAG_COUNT);t.genreIds=g.horror,t.mediaType="movie",t.sortBy="popularity.desc";break;case"scifi":t.genreIds=g.scifi,t.sortBy="popularity.desc";break;case"animation":return F(g.animation,h.SINGLE_TAG_COUNT,e.ottIds);case"documentary":t.genreIds=g.documentary,t.sortBy="popularity.desc";break;case"romance":t.genreIds=g.romance,t.sortBy="popularity.desc";break}return _({...e,...t})},ke=async e=>{const a={...e,count:h.COUNT},t={...a,sortBy:"popularity.desc"},r=async()=>!e.ottIds||e.ottIds.length===0?D(h.COUNT,"day"):_(t);return Promise.all([_({...a,sortBy:"primary_release_date.desc"}),r(),_({...t,genreIds:g.action,mediaType:"movie"}),_({...t,genreIds:g.comedy}),_({...t,genreIds:g.drama}),F(g.animation,h.COUNT,e.ottIds),_({...t,genreIds:g.horror,mediaType:"movie"})])},He=()=>{const{selectedOtts:e,activeTag:a}=B(),[t,r]=u.useState([]),[o,n]=u.useState([]),[l,d]=u.useState([]),[i,c]=u.useState([]),[y,N]=u.useState([]),[p,v]=u.useState([]),[S,T]=u.useState([]),[M,w]=u.useState(!0),[f,b]=u.useState(null),C=()=>{r([]),n([]),d([]),c([]),N([]),v([]),T([])},A=u.useCallback(async()=>{w(!0),b(null);try{const x={ottIds:e};if(a&&a!=="all"){const R=await Ge(x,a);C(),n(R)}else{const[R,U,P,$,W,K,q]=await ke(x);r(R),n(U),d(P),c($),N(W),v(K),T(q)}}catch(x){console.error("Error fetching movies:",x),b("영화를 불러오는 데 실패했습니다."),C()}finally{w(!1)}},[e,a]);u.useEffect(()=>{A()},[A]);const H=!M&&!f&&[t,o,l,i,y,p,S].every(x=>x.length===0);return s.jsxs(fe,{children:[s.jsxs(xe,{children:[s.jsx(we,{}),s.jsx(Me,{})]}),s.jsxs(je,{children:[M&&s.jsx("div",{className:"loading",children:"영화 로딩 중..."}),f&&s.jsx("div",{className:"error",children:f}),!M&&!f&&s.jsxs(s.Fragment,{children:[a!=="all"?s.jsxs(s.Fragment,{children:[o.length>0&&s.jsx(Re,{movie:o[0]}),s.jsx(Ne,{movies:o,title:G(a||"all")}),o.length>5&&s.jsx(O,{movies:o.slice(5,26),title:`${G(a||"all")} 더보기`})]}):s.jsxs(s.Fragment,{children:[t.length>0&&s.jsx(m,{movies:t,title:"신작"}),o.length>0&&s.jsx(m,{movies:o,title:"인기"}),l.length>0&&s.jsx(m,{movies:l,title:"액션"}),i.length>0&&s.jsx(m,{movies:i,title:"코미디"}),y.length>0&&s.jsx(m,{movies:y,title:"드라마"}),p.length>0&&s.jsx(m,{movies:p,title:"애니메이션"}),S.length>0&&s.jsx(m,{movies:S,title:"공포"})]}),H&&s.jsx("div",{className:"no-results",children:"표시할 영화가 없습니다. 필터를 조정해보세요."})]})]})]})};export{He as default};
