import{u as R,j as r,S as k,T as G,a as O,r as u,b as D,g as F,c as H,R as U,W as $,d as B,L,e as P,f as W,h as K,i as q,F as V,M as z,C as J,k as C,l as Y,H as Q,m as X,n as Z,o as ee,p as te,q as b,s as re,t as se,P as ae,v as f,w as E,A as h,x as oe,y as v,G as g,z as ne}from"./index-Cn62k1DJ.js";import{S as ie,a as ce,b as le}from"./styles-ODyTJ7J8.js";import{f as de,a as pe}from"./omdbApi-BFlhVuM9.js";const ge=()=>{const{activeTag:t,setActiveTag:a}=R();return r.jsx(k,{children:G.map(e=>r.jsx(O,{$active:t===e.key,onClick:()=>a(e.key),children:e.label},e.key))})},ue=()=>{const{selectedOtts:t}=R(),[a,e]=u.useState([]),[s,o]=u.useState(!0),[n,d]=u.useState(null);if(u.useEffect(()=>{(async()=>{try{const l=await F();e(l||[])}catch(l){console.error("Error fetching all watch providers:",l),d("OTT 제공사 정보를 불러오는 데 실패했습니다.")}finally{o(!1)}})()},[]),s)return null;if(n)return r.jsx("p",{style:{color:"red"},children:n});const c=a.filter(i=>t.includes(i.provider_id));return r.jsxs(D,{children:[r.jsx("div",{className:"label",children:"선택된 서비스 :"}),r.jsx("div",{className:"otts-list",children:c.length===0?r.jsx("span",{className:"no-selection",children:"선택된 서비스가 없습니다"}):c.map(i=>r.jsx("img",{className:"ott-item",src:`https://image.tmdb.org/t/p/original${i.logo_path}`,alt:i.provider_name,title:i.provider_name},i.provider_id))})]})},he=({movie:t,rank:a})=>{const e=t.name&&!t.title?"tv":"movie",s=`/detail/${t.id}?type=${e}`,o=t.title||t.name||"제목 없음";return r.jsxs(H,{children:[r.jsx(U,{children:a}),r.jsx($,{children:r.jsx(B,{movieId:t.id})}),r.jsx(L,{to:s,children:t.poster_path?r.jsx("img",{src:`https://image.tmdb.org/t/p/w500${t.poster_path}`,alt:o}):r.jsx("div",{className:"no-image",children:"No Image"})})]})},ye=({movies:t,title:a})=>{const e=t.slice(0,5);return r.jsxs(P,{children:[r.jsx("h2",{children:a}),r.jsx(W,{children:e.map((s,o)=>r.jsx(he,{movie:s,rank:o+1},s.id))})]})},_=({movies:t,title:a})=>{if(t.length===0)return null;const e=t.slice(0,5),s=t.slice(5,26);return r.jsxs(K,{children:[r.jsx(q,{children:r.jsx("h3",{children:a})}),r.jsx(V,{children:e.map(o=>r.jsx("div",{className:"grid-item",children:r.jsx(z,{movie:o})},o.id))}),s.length>0&&r.jsx(J,{children:r.jsx(C,{movies:s,title:`${a} 더보기`})})]})},me=({movie:t})=>{var n;const[a,e]=u.useState(!1),[s,o]=u.useState({imdbRating:null,rottenTomatoesRating:null});return u.useEffect(()=>{const d=new Image;d.onload=()=>e(!0),d.src=`https://image.tmdb.org/t/p/original${t.backdrop_path}`},[t.backdrop_path]),u.useEffect(()=>{(async()=>{try{const c=await de(t.id);if(c){const i=await pe(c);i&&o({imdbRating:i.imdbRating,rottenTomatoesRating:i.rottenTomatoesRating})}}catch(c){console.error("Error fetching ratings:",c)}})()},[t.id]),r.jsxs(Y,{children:[r.jsx(Q,{style:{backgroundImage:a?`url(https://image.tmdb.org/t/p/original${t.backdrop_path})`:"none"}}),r.jsx(X,{children:r.jsxs(Z,{children:[r.jsx(ee,{children:t.title||t.name}),r.jsxs(te,{children:[r.jsxs(b,{children:[r.jsx("span",{className:"imdb-label",children:"IMDB"}),r.jsx("span",{className:"rating-score",children:s.imdbRating||((n=t.vote_average)==null?void 0:n.toFixed(1))||"8.2"})]}),r.jsxs(b,{className:"rotten-tomatoes",children:[r.jsx("span",{className:"rt-label",children:"🍅"}),r.jsx("span",{className:"rt-score",children:s.rottenTomatoesRating||`${Math.round((t.vote_average||8.2)*8.5)}%`})]}),r.jsx("span",{className:"release-year",children:t.release_date?new Date(t.release_date).getFullYear():"2024"})]}),r.jsx(re,{children:t.overview?t.overview.length>180?`${t.overview.substring(0,180)}...`:t.overview:"줄거리 정보가 없습니다."}),r.jsxs(se,{children:[r.jsx(L,{to:`/detail/${t.id}?type=${t.media_type||(t.name&&!t.title?"tv":"movie")}`,children:r.jsx(ae,{children:"상세보기"})}),r.jsx(B,{movieId:t.id})]})]})})]})},T=async(t,a=20)=>{try{const e=await f.get("/trending/all/day"),s=new Date().toISOString().split("T")[0],o=e.data.results.filter(n=>{var l;const d=(l=n.genre_ids)==null?void 0:l.some(y=>t.includes(y)),c=n.release_date||n.first_air_date,i=c&&c<=s;return d&&i}).map(n=>({...n,media_type:n.media_type||(n.title?"movie":"tv")})).slice(0,Math.min(a,10));if(o.length<a){const n=a-o.length,[d,c]=await Promise.all([f.get("/discover/movie",{params:{with_genres:t.join(","),sort_by:"popularity.desc","primary_release_date.lte":s,"primary_release_date.gte":"2020-01-01","vote_count.gte":10}}),f.get("/discover/tv",{params:{with_genres:t.join(","),sort_by:"popularity.desc","first_air_date.lte":s,"first_air_date.gte":"2020-01-01","vote_count.gte":10}})]),i=[...d.data.results.map(l=>({...l,media_type:"movie"})),...c.data.results.map(l=>({...l,media_type:"tv"}))].filter(l=>!o.some(y=>y.id===l.id)).sort((l,y)=>(y.popularity||0)-(l.popularity||0)).slice(0,n);o.push(...i)}return o.slice(0,a)}catch(e){throw console.error("Error fetching genre-based trending:",e),e}},_e=t=>{const a=t.title||t.name||"",e=Math.max(100-a.length*2,10),s=(t.vote_average||5)*10,o=Math.log((t.vote_count||1)+1)*5;return e+s+o},ve=t=>{const a=t.release_date||t.first_air_date;if(!a)return 0;const e=new Date,s=new Date(a),o=Math.abs((e.getTime()-s.getTime())/(1e3*60*60*24));return o<=30?100:o<=90?80:o<=365?60:o<=365*2?40:20},fe=t=>{const a=t.popularity||0,e=t.vote_average||0,s=t.vote_count||0;return a*.4+e*10*.3+Math.log(s+1)*5*.3},je=t=>{const a=(t.title||t.name||"").toLowerCase(),e=["시즌","season","완결","신작","화제","마블","marvel","디즈니","disney","넷플릭스","netflix","스파이더맨","어벤져스","원피스","나루토","귀멸의칼날","오징어게임","킹덤","지옥","라라랜드","탑건"];let s=0;return e.forEach(o=>{a.includes(o)&&(s+=20)}),Math.min(s,100)},xe=t=>t.map(e=>{const s=e.popularity||0,o=ve(e),n=fe(e),d=je(e),c=_e(e),i=s*.25+o*.2+n*.25+d*.15+c*.15;return{...e,_truePopularityScore:i}}).sort((e,s)=>(s._truePopularityScore||0)-(e._truePopularityScore||0)),A=async(t,a=20,e)=>{try{const s=new Date().toISOString().split("T")[0];let o=[];(!e||e.length===0)&&(o=(await f.get("/trending/all/day")).data.results.filter(j=>{var S;const w=(S=j.genre_ids)==null?void 0:S.some(I=>t.includes(I)),x=j.release_date||j.first_air_date,M=x&&x<=s;return w&&M}).slice(0,10));const n={with_genres:t.join(","),sort_by:"popularity.desc","primary_release_date.lte":s,"primary_release_date.gte":"2022-01-01","vote_count.gte":20},d={with_genres:t.join(","),sort_by:"popularity.desc","first_air_date.lte":s,"first_air_date.gte":"2022-01-01","vote_count.gte":15};e&&e.length>0&&(n.with_watch_providers=e.join("|"),n.watch_region="KR",d.with_watch_providers=e.join("|"),d.watch_region="KR");const[c,i]=await Promise.all([f.get("/discover/movie",{params:n}),f.get("/discover/tv",{params:d})]),l=[...o.map(p=>({...p,media_type:p.media_type||(p.title?"movie":"tv")})),...c.data.results.map(p=>({...p,media_type:"movie"})),...i.data.results.map(p=>({...p,media_type:"tv"}))],y=Array.from(new Map(l.map(p=>[p.id,p])).values());return xe(y).slice(0,a)}catch(s){throw console.error("Error fetching true popular content:",s),s}},Se=t=>ne[t]||"콘텐츠",Te=async(t,a)=>{const e={sortBy:"popularity.desc",count:h.SINGLE_TAG_COUNT};switch(a){case"new":{e.sortBy="popularity.desc";const s=new Date;s.setMonth(s.getMonth()-h.RECENT_MONTHS);const o=s.toISOString().split("T")[0];return oe(o,h.SINGLE_TAG_COUNT,t.ottIds)}case"trending_day":if(!t.ottIds||t.ottIds.length===0)return E(h.SINGLE_TAG_COUNT,"day");e.sortBy="popularity.desc";break;case"action":if(!t.ottIds||t.ottIds.length===0)return T(g.action,h.SINGLE_TAG_COUNT);e.genreIds=g.action,e.mediaType="movie",e.sortBy="popularity.desc";break;case"comedy":if(!t.ottIds||t.ottIds.length===0)return T(g.comedy,h.SINGLE_TAG_COUNT);e.genreIds=g.comedy,e.sortBy="popularity.desc";break;case"drama":if(!t.ottIds||t.ottIds.length===0)return T(g.drama,h.SINGLE_TAG_COUNT);e.genreIds=g.drama,e.sortBy="popularity.desc";break;case"horror":if(!t.ottIds||t.ottIds.length===0)return T(g.horror,h.SINGLE_TAG_COUNT);e.genreIds=g.horror,e.mediaType="movie",e.sortBy="popularity.desc";break;case"scifi":e.genreIds=g.scifi,e.sortBy="popularity.desc";break;case"animation":return A(g.animation,h.SINGLE_TAG_COUNT,t.ottIds);case"documentary":e.genreIds=g.documentary,e.sortBy="popularity.desc";break;case"romance":e.genreIds=g.romance,e.sortBy="popularity.desc";break}return v({...t,...e})},we=async t=>{const a={...t,count:h.COUNT},e={...a,sortBy:"popularity.desc"},s=async()=>!t.ottIds||t.ottIds.length===0?E(h.COUNT,"day"):v(e);return Promise.all([v({...a,sortBy:"primary_release_date.desc"}),s(),v({...e,genreIds:g.action,mediaType:"movie"}),v({...e,genreIds:g.comedy}),v({...e,genreIds:g.drama}),A(g.animation,h.COUNT,t.ottIds),v({...e,genreIds:g.horror,mediaType:"movie"})])},N={new:[],popular:[],action:[],comedy:[],drama:[],animation:[],horror:[]},Re=()=>{const{selectedOtts:t,activeTag:a}=R(),[e,s]=u.useState(N),[o,n]=u.useState({isLoading:!0,error:null}),d=u.useCallback(()=>{s(N)},[]),c=u.useCallback(async()=>{n({isLoading:!0,error:null});try{const m={ottIds:t};if(a&&a!=="all"){const p=await Te(m,a);s({...N,popular:p})}else{const[p,j,w,x,M,S,I]=await we(m);s({new:p,popular:j,action:w,comedy:x,drama:M,animation:S,horror:I})}n({isLoading:!1,error:null})}catch(m){console.error("Error fetching movies:",m);const p=m instanceof Error?m.message:"영화 정보를 불러오는데 실패했습니다.";n({isLoading:!1,error:p}),d()}},[t,a,d]);u.useEffect(()=>{c()},[c]);const i=u.useMemo(()=>Object.values(e),[e]),l=u.useMemo(()=>!o.isLoading&&!o.error&&i.every(m=>m.length===0),[o.isLoading,o.error,i]),y=u.useMemo(()=>Se(a||"all"),[a]);return r.jsxs(ie,{children:[r.jsxs(ce,{children:[r.jsx(ue,{}),r.jsx(ge,{})]}),r.jsxs(le,{children:[o.isLoading&&r.jsx("div",{className:"loading",children:"영화 로딩 중..."}),o.error&&r.jsx("div",{className:"error",children:o.error}),!o.isLoading&&!o.error&&r.jsxs(r.Fragment,{children:[a!=="all"?r.jsxs(r.Fragment,{children:[e.popular.length>0&&r.jsx(me,{movie:e.popular[0]}),r.jsx(ye,{movies:e.popular,title:y}),e.popular.length>5&&r.jsx(C,{movies:e.popular.slice(5,26),title:`${y} 더보기`})]}):r.jsxs(r.Fragment,{children:[e.new.length>0&&r.jsx(_,{movies:e.new,title:"신작"}),e.popular.length>0&&r.jsx(_,{movies:e.popular,title:"인기"}),e.action.length>0&&r.jsx(_,{movies:e.action,title:"액션"}),e.comedy.length>0&&r.jsx(_,{movies:e.comedy,title:"코미디"}),e.drama.length>0&&r.jsx(_,{movies:e.drama,title:"드라마"}),e.animation.length>0&&r.jsx(_,{movies:e.animation,title:"애니메이션"}),e.horror.length>0&&r.jsx(_,{movies:e.horror,title:"공포"})]}),l&&r.jsx("div",{className:"no-results",children:"표시할 영화가 없습니다. 필터를 조정해보세요."})]})]})]})};export{Re as default};
