# -------------------- 1단계: 빌드 스테이지 (Builder) --------------------
# Node.js 18 버전을 명시적으로 사용
FROM node:18-alpine AS builder

# 작업 디렉토리 설정
WORKDIR /usr/src/app

# package.json과 package-lock.json을 먼저 복사
COPY package*.json ./

# npm ci: package-lock.json을 기반으로 정확한 버전의 의존성을 설치. CI 환경에 최적화.
RUN npm ci

# .env 파일을 포함한 나머지 모든 소스코드 복사
COPY . .

# 빌드 시 필요한 환경 변수 인자 선언
ARG VITE_TMDB_API_KEY
ARG VITE_OMDB_API_KEY
ARG VITE_YOUTUBE_API_KEY

# 받은 인자들을 빌드 환경의 환경 변수로 설정
ENV VITE_TMDB_API_KEY=$VITE_TMDB_API_KEY
ENV VITE_OMDB_API_KEY=$VITE_OMDB_API_KEY
ENV VITE_YOUTUBE_API_KEY=$VITE_YOUTUBE_API_KEY

# React 앱 빌드 실행
RUN npm run build


# -------------------- 2단계: 최종 스테이지 (Final) --------------------
FROM nginx:stable-alpine
COPY --from=builder /usr/src/app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]