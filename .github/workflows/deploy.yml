# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: CI/CD for Flic Flow

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´: main ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí–ˆì„ ë•Œë§Œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  # 1. ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì¡ (Build and Test Job)
  build_and_test:
    runs-on: ubuntu-latest # GitHub ì œê³µ ê°€ìƒë¨¸ì‹ ì—ì„œ ì‹¤í–‰

    steps:
      # 1-1. ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v4

      # 1-2. GitHub Secretsë¥¼ ì‚¬ìš©í•˜ì—¬ .env íŒŒì¼ ìƒì„±
      # ë¹Œë“œ ê³¼ì •ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì½ê¸° ìœ„í•´ í•„ìš”
      - name: Create .env file for build
        run: |
          echo "VITE_TMDB_API_KEY=${{ secrets.VITE_TMDB_API_KEY }}" > .env
          echo "VITE_OMDB_API_KEY=${{ secrets.VITE_OMDB_API_KEY }}" >> .env
          echo "VITE_YOUTUBE_API_KEY=${{ secrets.VITE_YOUTUBE_API_KEY }}" >> .env

      # 1-3. Docker Buildx ì„¤ì • (ë©€í‹° í”Œë«í¼ ë¹Œë“œ ì§€ì›)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 1-4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image for testing
        run: docker build -t temp-flic-flow-test:latest .

      # 1-5. ë¹Œë“œëœ ì´ë¯¸ì§€ë¡œ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run a simple test on the built image
        run: |
          docker run -d -p 8080:80 --name test-container temp-flic-flow-test:latest
          echo "Waiting for container to start..."
          sleep 15
          echo "Checking if the server is responsive..."
          curl -f http://localhost:8080 || (docker logs test-container && exit 1)
          echo "Test passed!"
          docker stop test-container
          docker rm test-container

  # 2. Docker Hub ë°°í¬ ì¡ (SSH ë°°í¬ ì œê±°)
  deploy:
    needs: build_and_test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/flic-flow:latest
          build-args: |
            VITE_TMDB_API_KEY=${{ secrets.VITE_TMDB_API_KEY }}
            VITE_OMDB_API_KEY=${{ secrets.VITE_OMDB_API_KEY }}
            VITE_YOUTUBE_API_KEY=${{ secrets.VITE_YOUTUBE_API_KEY }}
            
      - name: Deployment Instructions
        run: |
          echo "ğŸš€ Docker image successfully built and pushed to Docker Hub!"
          echo "ğŸ“ To deploy manually on your server, run:"
          echo "docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/flic-flow:latest"
          echo "docker stop flic-flow-container || true"
          echo "docker rm flic-flow-container || true"
          echo "docker run -d -p 127.0.0.1:8080:80 --name flic-flow-container --restart=unless-stopped ${{ secrets.DOCKER_HUB_USERNAME }}/flic-flow:latest"
